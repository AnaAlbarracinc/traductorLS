<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Teachable Machine Camera</title>

<style>
  body {
    margin: 0;
    overflow: hidden;
    background: black;
  }
  video, canvas {
    display: none; /* no mostramos nada */
  }
</style>
</head>

<body>

<!-- MENSAJE DE PERMISO -->
<div id="mensaje-permiso" style="
  position:fixed; top:0; left:0; width:100%; height:100%;
  background-color:rgba(0,0,0,0.7); color:white;
  display:flex; flex-direction:column;
  justify-content:center; align-items:center;
  font-size:18px; z-index:1000;">
  <div style="padding:20px; text-align:center;">
    <p>Para usar el traductor de lengua de signos, necesitamos acceder a la cámara.</p>
    <button id="boton-permiso" style="padding:10px 20px; font-size:16px;">
      Aceptar
    </button>
  </div>
</div>

<video id="webcam" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<!-- LIBRERÍAS -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<script>
/* ========= CONFIG ========= */
const URL = "https://storage.googleapis.com/tm-model/PBMe15z0B/"; // <-- TU MODELO
let model, webcam, maxPredictions;
let running = false;

/* ========= BOTÓN PERMISO ========= */
document.getElementById("boton-permiso").addEventListener("click", async () => {
  try {
    await navigator.mediaDevices.getUserMedia({ video: true });
    document.getElementById("mensaje-permiso").style.display = "none";
    await startCameraAndModel();
  } catch (err) {
    alert("No se puede usar la app sin permitir la cámara.");
  }
});

/* ========= INICIAR CÁMARA + MODELO ========= */
async function startCameraAndModel() {
  try {
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    model = await tmImage.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();

    webcam = new tmImage.Webcam(224, 224, true);
    await webcam.setup();
    await webcam.play();

    running = true;
    window.requestAnimationFrame(loop);

  } catch (e) {
    window.AppInventor.setWebViewString("ERROR_CAMARA_O_MODELO");
  }
}

/* ========= BUCLE DE CLASIFICACIÓN ========= */
async function loop() {
  if (!running) return;

  webcam.update();
  await predict();
  window.requestAnimationFrame(loop);
}

/* ========= PREDICCIÓN ========= */
async function predict() {
  const predictions = await model.predict(webcam.canvas);

  let best = predictions[0];
  for (let i = 1; i < predictions.length; i++) {
    if (predictions[i].probability > best.probability) {
      best = predictions[i];
    }
  }

  if (best.probability > 0.6) {
    window.AppInventor.setWebViewString(best.className);
  }
}

/* ========= PARAR (OPCIONAL) ========= */
function stopCamera() {
  running = false;
  if (webcam) webcam.stop();
}
</script>

</body>
</html>
